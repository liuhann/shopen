<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
      <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- 引入样式 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.14/howler.core.min.js"></script>
    <style>
        .van-popup--right {
            left: 30px;
        }
        body {
            margin: 0;
            padding: 0;
        }
        .el-table {
            overflow: auto;
        }
        .el-table .cell {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
        }

        .cover-image {
            width: 60px;
            height: 60px;
        }

        .one-story {
          width: 200px;
          font-size: 12px;
          height: 120px;
          float: left;
          border: 1px solid #ccc;
          margin: 10px;
        }
    </style>
</head>
<body>
<div id="app">
  <el-container>
    <el-header>
        <div class="pager">
            <a @click="jumpPage(-1)">上页</a>
            <a @click="jumpPage(1)">下页</a>
            <input v-model.number="currentPage">
            <a @click="jumpPage(0)">跳转</a>
        </div>
    </el-header>
    <el-aside>

    </el-aside>
    <el-main>
      <div class="one-story" v-for="(story, index) in tableData" :key="story._id">
        <img v-if="story.cover" :src="CDN_IMG + '/' + story.cover + '.png@w_24,h_24,s_2,q_80'">
        <input v-model="story.title">
        <input v-model="story.album">
        <input v-model="story.label">
        <input v-model="story.teller">
        <a @click="saveStory(story)">更新</a>
        <span>{{story.path}}</span>
      </div>
    </el-main>
  </el-container>
</div>

<script>
const app = new Vue({
    el: '#app',
    data() {
      return {
        CDN_IMG: 'http://imagek.cdn.bcebos.com',
        pageToGo: '',
        queryText: '',
        showRelatedStory: false,
        showSearchDialog: false,
        relatedStories: [],
        currentPage: 1,
        pageSize: 100,
        total: 0,
        tableData: [],
        loading: false,
        currentPlaying: null,
        dialogFormVisible: false,
      }
    },

    mounted() {
      this.loadCurrentPage()
    },

    computed: {
      currentPlayingUrl() {
        if (this.currentPlaying) {
          return '/api/story/mp3/' + this.currentPlaying._id
        } else {
          return null
        }
      }
    },
    methods: {
      jumpPage (inc) {
        this.currentPage += inc
        this.loadCurrentPage()
      },

      async loadAlbums () {

      },

      async loadLabels () {

      },

      async loadTellers () {

      },

      async loadCurrentPage () {
        this.loading = true;
        const result = await axios.get('/api/story/admin/list?skip=' + (this.currentPage - 1) * this.pageSize + '&limit=' + this.pageSize);
        debugger
        this.loading = false;
        this.tableData = result.data.list
        this.total = result.data.total
      },

      async sizeChange (size) {
        this.pageSize = size;
        await this.loadCurrentPage();
      },

      async handleCurrentChange(page) {
        //this.currentPage = page
        localStorage.setItem('page', this.currentPage);
        await this.loadCurrentPage()
      },

      editStory (story) {
        this.dialogFormVisible = true;
        this.currentEditing = JSON.stringify(story, null, 2);
      },

      playStory (story) {
        this.currentPlaying = story
        if (this.howlStory) {
          this.howlStory.unload()
        }
        this.howlStory = new Howl({
          src: ['/api/story/mp3/' + story._id],
          html5: true,
          format: ['mp3']
        });
        this.howlStory.play();
        vant.Dialog.alert({
          title: '正在播放',
          message: '弹窗内容'
        }).then(() => {
          if (this.howlStory) {
            this.howlStory.unload()
          }
        });
      },

      pausePlay (story) {
        if (this.howlStory) {
          this.howlStory.unload()
        }
      },

      async removeStory (story, notRefresh) {
        const json = await axios.get('/api/story/delete/mark/' + story._id).json();
        //vant.Toast('删除成功');
        if (notRefresh) {
          for (let i = 0; i < this.tableData.length; i++) {
            if (this.tableData[i]._id === story._id) {
              this.tableData.splice(i, 1)
              break
            }
          }
          return
        } else {
          await this.loadCurrentPage()
        }
      },

      async deleteMarked () {
        let json = (await axios.get('/api/story/delete/one')).data
        while (json.path) {
          vant.Notify(json.path)
          await this.sleep(500)
          json = (await axios.get('/api/story/delete/one')).data
        }
      },

      async showQueryBox (story) {
        this.showSearchDialog = true
        this.currentEditing = story
        this.queryText = story.path
      },

      // 标题中包含
      async getSameTitle () {
        const sameNames = await ky.get(`/api/story/search?query=${this.queryText}&skip=0&limit=100`).json();
        if (sameNames.length > 1) {
          this.relatedStories = []
          for (let same of sameNames) {
            this.relatedStories.push(same)
          }
          this.showRelatedStory = true
        }
      },

      // 按路径搜索
      async getSameAlbum () {
        const paths = this.queryText.split('/')
        let path = paths[0] || paths[1]
        const sameNames = await ky.get(`/api/story/search/path?query=${path}/&skip=0&limit=50`).json();
        if (sameNames.length > 100) {
          this.relatedStories = sameNames.slice(0, 100)
        } else {
	        this.relatedStories = sameNames
        }
        this.showRelatedStory = true
      },

      async replaceStoryTitle (story) {
        await ky.post(`/api/story/props/${this.currentEditing._id}`, {json: {
            cover: story.cover
        }})
        this.showRelatedStory = false;
        this.loadCurrentPage();
      },

      formateMill (mill) {
        const d = new Date(mill);
        return d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
      },

      unRelatedThis(index) {
        this.relatedStories.splice(index, 1)
      },

      async removeAllRelated () {
        let story = this.relatedStories.pop()
        while (story) {
          await this.removeStory(story, true)
          story = this.relatedStories.pop()
        }
        this.showRelatedStory = false
        this.loadCurrentPage()
      },

      async sleep(mill) {
        return new Promise((resolve, reject) => {
          setTimeout(()=>{
            resolve()
          }, mill)
        })
      },

      async saveStory (story) {
        try {
          await axios.post('/api/story/update', {
            _id: story._id,
            title: story.title,
            album: story.album,
            label: story.label,
            teller: story.teller
          })
        } catch (e) {

        }
      }
    }
})
</script>
</body>
</html>
