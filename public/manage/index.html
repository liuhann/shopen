<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/vant/lib/vant-css/index.css">
    <!-- 引入组件 -->
    <script src="https://unpkg.com/vant/lib/vant.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.14/howler.core.min.js"></script>
    <!--&lt;!&ndash; 引入样式 &ndash;&gt;
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    &lt;!&ndash; 引入组件库 &ndash;&gt;
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>-->
    <style>

        body {
            margin: 0;
            padding: 0;
        }
        .el-table {
            overflow: auto;
        }
        .el-table .cell {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
        }

        .cover-image {
            width: 60px;
            height: 60px;
        }

    </style>
</head>
<body>
<div id="app">
    <div class="grid-content bg-purple">
        <van-card v-for="(story, index) in tableData" :key="story._id"
                :tag="story.u?formateMill(story.u): ''"
                :desc="story.path"
                :title="story.title"
                :thumb="story.cover? ('/story/cover/480/480/' + story.cover + '.png') : ''"
                origin-price="10.00">
            <div slot="footer">
                <van-button @click="playStory(story)" size="mini">播放</van-button>
                <van-button @click="removeStory(story)" size="mini">删除</van-button>
            </div>
        </van-card>
        <van-popup v-model="loading">
            加载中
        </van-popup>

        <van-pagination
                v-model="currentPage"
                @change="handleCurrentChange"
                :total-items="total"
                :items-per-page="10"/>

        <!--<el-table
                max-height="900px"
                v-loading.fullscreen.lock="loading"
                :data="tableData"
                size="mini">
            <el-table-column label=" " width="120">
                <template slot-scope="scope">
                    <img class="cover-image" v-if="scope.row.cover" :src="'/story/cover/480/480/' + scope.row.cover + '.png'">
                    <div class="cover-image" v-else style="background: #aaa"></div>
                </template>
            </el-table-column>
            <el-table-column
                    prop="title"
                    label="标题"
                    width="480">
                <template slot-scope="scope">
                    <div>{{scope.row.title}}</div>
                    <div>{{scope.row.album || scrope.row.path.split('/')[0]}}</div>
                </template>
            </el-table-column>
            <el-table-column
                    width="120"
                    label="更新时间">
                <template slot-scope="scope">
                    <span class="desc" v-if="scope.row.u">{{formateMill(scope.row.u)}}</span>
                </template>
            </el-table-column>
            <el-table-column
                    label="描述">
                <template slot-scope="scope">
                    <span class="desc">{{scope.row.desc}}</span>
                </template>
            </el-table-column>
            <el-table-column
                    label="操作"
                    width="100">
                <template slot-scope="scope">
                    <el-button @click="removeStory(scope.row)" type="text" size="small">删除</el-button>
                    <el-button @click="editStory(scope.row)" type="text" size="small">编辑</el-button>
                    &lt;!&ndash;<el-button @click="playStory(scope.row)" type="text" size="small">播放</el-button>&ndash;&gt;
                </template>
            </el-table-column>
        </el-table>
        <el-pagination
                :page-size="pageSize"
                :current-page="currentPage"
                @current-change="handleCurrentChange"
                @size-change="sizeChange"
                layout="total, sizes, prev, pager, next, jumper"
                :total="total">
        </el-pagination>-->
    </div>
</div>

<script type="module">
import ky from './js/ky.js'

const app = new Vue({
    el: '#app',
    data() {
      return {
        currentPage: 1,
        pageSize: 10,
        total: 0,
        tableData: [],
        loading: false,
        currentPlaying: null,
        dialogFormVisible: false,
        currentEditing: null
      }
    },

    mounted() {
      this.loadCurrentPage()
      setTimeout(() => {
        if (localStorage.getItem('page')) {
          this.currentPage = parseInt(localStorage.getItem('page'));
          this.loadCurrentPage();
        }
      }, 2000)
      //this.loadCurrentPage()
    },

    computed: {
      currentPlayingUrl() {
        if (this.currentPlaying) {
          return '/story/mp3/' + this.currentPlaying._id
        } else {
          return null
        }
      }
    },

    methods: {
      async loadCurrentPage () {
        this.loading = true;
        const result = await axios.get('/story/admin/list?skip=' + (this.currentPage - 1) * this.pageSize + '&limit=' + this.pageSize);
        this.loading = false;
        this.tableData = result.data.list
        this.total = result.data.total
      },

      async sizeChange (size) {
        this.pageSize = size;
        await this.loadCurrentPage();
      },

      async handleCurrentChange(page) {
        //this.currentPage = page
        localStorage.setItem('page', this.currentPage);
        await this.loadCurrentPage()
      },

      editStory (story) {
        this.dialogFormVisible = true;
        this.currentEditing = JSON.stringify(story, null, 2);
      },

      playStory (story) {
        this.currentPlaying = story
        if (this.howlStory) {
          this.howlStory.unload()
        }
        this.howlStory = new Howl({
          src: ['/story/mp3/' + story._id],
          html5: true,
          format: ['mp3']
        });
        this.howlStory.play();
        vant.Dialog.alert({
          title: '正在播放',
          message: '弹窗内容'
        }).then(() => {
          if (this.howlStory) {
            this.howlStory.unload()
          }
        });
      },

      pausePlay (story) {
        if (this.howlStory) {
          this.howlStory.unload()
        }
      },

      async removeStory (story) {
        const json = await ky.get('/story/delete/' + story._id).json();
        vant.Toast('删除成功');
        await this.loadCurrentPage ()
      },

      formateMill (mill) {
        const d = new Date(mill);
        return d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
      },

      async saveStory () {
        this.dialogFormVisible = false;
        try {
          let json = JSON.parse(this.currentEditing)
          await axios.post('http://118.25.210.124/story/update', {
            _id: json._id,
            title: json.title,
            desc: json.desc
          })
          this.loadCurrentPage();
        } catch (e) {

        }
      }
    }
})
</script>
</body>
</html>
